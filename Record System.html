<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Record System</title>
<style>
/* === å…¨å±€è®Šæ•¸ === */
:root{ 
  --bg:#020617; 
  --text:#e5e7eb; 
  --blue:#38bdf8; 
  --orange:#fb923c; 
  --green:#4ade80; 
  --red:#ef4444;
  --border:rgba(148,163,184,.18); 
  --panel-light: #0f172a;
}

body{ margin:0; font-family:"Segoe UI"; background:radial-gradient(circle at top,#1e293b,#020617); color:var(--text); }
.container{ width:95%; margin:30px auto; padding:30px; background:#162235; border-radius:24px; border:1px solid var(--border); }

/* === Header & Filter === */
.header{ display:flex; gap:15px; margin-bottom:20px; align-items:center;}
.header h1{ flex:1; margin:0; font-size:28px; color:var(--text); }

.btn-group{ display:flex; gap:5px; background:var(--panel-light); padding:5px; border-radius:12px; }

/* ç¯©é¸æŒ‰éˆ•åŸºç¤æ¨£å¼ */
.filter-btn{ 
  padding:8px 20px; 
  border:none; 
  background:transparent; 
  color:#64748b; 
  cursor:pointer; 
  font-weight:bold; 
  transition: all 0.2s;
  border-radius: 8px;
}

.filter-btn:hover { background: rgba(255,255,255,0.05); color: #94a3b8; }
/* Active Colors */
.filter-btn[data-mode="OPEN"].active { background: #ef4444; color: #fff; box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
.filter-btn[data-mode="CLOSE"].active { background: #22c55e; color: #fff; box-shadow: 0 0 10px rgba(34, 197, 94, 0.4); }
.filter-btn[data-mode="ALL"].active { background: #38bdf8; color: #000; box-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }

/* â˜…â˜…â˜… æ–°å¢ï¼šPRI ä¸‹æ‹‰ç¯©é¸å™¨æ¨£å¼ â˜…â˜…â˜… */
.pri-filter-select {
  padding: 10px 15px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--panel-light);
  color: var(--blue);
  font-weight: bold;
  cursor: pointer;
  outline: none;
  font-family: inherit;
}
.pri-filter-select option {
  background: var(--panel-light);
  color: var(--text);
  padding: 10px;
}

/* æ“ä½œæŒ‰éˆ• */
.btn{ padding:10px 20px; border-radius:12px; cursor:pointer; border:1px solid var(--border); font-weight:bold; }
.btn-blue{ background:#0f172a; color:var(--blue); } 
.btn-red{ background:#0f172a; color:#fecaca; }

/* === Table === */
.table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
.table th{ text-align:left; color:var(--orange); padding:10px; font-size:14px; }
.table tr{ background:linear-gradient(180deg,#1e293b,#0f172a); }
.table td{ padding:12px 10px; vertical-align:middle; }
.cell-text { color: var(--blue); font-size: 16px; }

/* PRI ç‡ˆè™Ÿæ¨£å¼ */
.pri-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 14px;
  text-align: center;
  min-width: 60px;
}
.pri-red { background: #ef4444; color: white; }    /* High */
.pri-green { background: #22c55e; color: white; }  /* Low */
.pri-yellow { background: #eab308; color: black; } /* Midd */
.pri-gray { background: #64748b; color: white; }   /* End */
.pri-normal { color: var(--blue); }

.row-btn { padding:5px 15px; border-radius:8px; background:#1e293b; color:var(--blue); border:1px solid var(--border); cursor:pointer; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Event List</h1>
    
    <div class="btn-group">
      <button class="filter-btn active" data-mode="OPEN" onclick="load('OPEN')">Open</button>
      <button class="filter-btn" data-mode="CLOSE" onclick="load('CLOSE')">Close</button>
      <button class="filter-btn" data-mode="ALL" onclick="load('ALL')">All</button>
    </div>

    <select id="priFilter" class="pri-filter-select" onchange="renderTable()">
      <option value="ALL">ğŸ’¡ All Lights</option>
      <option value="High">ğŸ”´ High (Red)</option>
      <option value="Low">ğŸŸ¢ Low (Green)</option>
      <option value="Midd">ğŸŸ¡ Midd (Yellow)</option>
      <option value="End">âšª End (Gray)</option>
    </select>

    <button class="btn btn-blue" onclick="location.href='New Event Record.html'">+ Add</button>
    <button class="btn btn-red" onclick="location.href='index.html'">Exit</button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th width="80">Action</th>
        <th width="100">Date</th>
        <th width="100">Project</th>
        <th width="120">Customer</th>
        <th width="120">Tool ID</th>
        <th width="100">PRI</th>
        <th>Problem</th>
        <th width="80">Add Log</th>
      </tr>
    </thead>
    <tbody id="listBody"></tbody>
  </table>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw3f4ch9YxN47QQ_Sa9vuTKk5-Y9yLJumm4wkozjWkxcMqiW9fAhLBxI2Lvd64DRrqn/exec';

// ç”¨ä¾†æš«å­˜å¾ GAS æŠ“å›ä¾†çš„è³‡æ–™ï¼Œæ–¹ä¾¿åšäºŒæ¬¡ç¯©é¸ (PRI Filter)
let cachedList = []; 
let currentFilterMode = 'OPEN';

// é è¨­è¼‰å…¥ OPEN
load('OPEN');

function load(filter){
  currentFilterMode = filter;

  // 1. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.remove('active');
    if(b.dataset.mode === filter) {
      b.classList.add('active');
    }
  });

  // 2. åˆ‡æ›åˆ†é æ™‚ï¼Œè‡ªå‹•é‡ç½® PRI ç¯©é¸å™¨ç‚º "All"ï¼Œé¿å…ä½¿ç”¨è€…ä»¥ç‚ºæ²’è³‡æ–™
  document.getElementById('priFilter').value = 'ALL';

  // 3. é¡¯ç¤º Loading
  document.getElementById('listBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">Loading...</td></tr>';
  
  // 4. å‘¼å« GAS
  fetch(`${API_URL}?mode=getList&filter=${filter}`)
  .then(r=>r.json())
  .then(res=>{
    if(!res.list){
      cachedList = [];
    } else {
      cachedList = res.list;
    }
    // è³‡æ–™æŠ“å›ä¾†å¾Œï¼ŒåŸ·è¡Œæ¸²æŸ“ (æœƒåƒè€ƒ PRI Filter çš„è¨­å®š)
    renderTable();
  })
  .catch(err => {
    console.error(err);
    document.getElementById('listBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:red;">Connection Error</td></tr>';
  });
}

function renderTable(){
  const tbody = document.getElementById('listBody');
  const priFilterVal = document.getElementById('priFilter').value; // å–å¾—ç›®å‰é¸çš„ç‡ˆè™Ÿ

  tbody.innerHTML = '';
  
  // â˜…â˜…â˜… äºŒæ¬¡ç¯©é¸ï¼šæ ¹æ“š PRI Filter éæ¿¾è³‡æ–™ â˜…â˜…â˜…
  const displayList = cachedList.filter(item => {
    if(priFilterVal === 'ALL') return true; // é¡¯ç¤ºå…¨éƒ¨
    return item.PRI === priFilterVal; // åªé¡¯ç¤ºç¬¦åˆç‡ˆè™Ÿçš„
  });

  if(displayList.length === 0){
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;color:#64748b;">No Data (Filter: ${currentFilterMode} / ${priFilterVal})</td></tr>`;
    return;
  }

  displayList.forEach(r => {
    // åˆ¤æ–·ç‡ˆè™Ÿé¡è‰² class
    let priClass = 'pri-normal';
    const p = r.PRI;
    if(p === 'High') priClass = 'pri-badge pri-red';
    else if(p === 'Low') priClass = 'pri-badge pri-green';
    else if(p === 'Midd') priClass = 'pri-badge pri-yellow';
    else if(p === 'End') priClass = 'pri-badge pri-gray';

    tbody.innerHTML += `
      <tr>
        <td><button class="row-btn" onclick="openDetail('${r.ID}')">Detail</button></td>
        <td class="cell-text">${r.Date}</td>
        <td class="cell-text">${r.Project}</td>
        <td class="cell-text">${r.Customer}</td>
        <td class="cell-text">${r.CustomerToolID}</td>
        
        <td><span class="${priClass}">${r.PRI || '-'}</span></td>
        
        <td class="cell-text">${r.Problem}</td>
        <td><button class="row-btn" onclick="openLog('${r.ID}')">+</button></td>
      </tr>`;
  });
}

function openDetail(id){ window.open(`Event Detail.html?eventId=${id}`, '_blank', 'width=1400,height=900'); }
function openLog(id){ window.open(`New Event Log.html?eventId=${id}`, '_blank', 'width=1200,height=800'); }
</script>
</body>
</html>