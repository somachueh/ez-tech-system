<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Event Detail</title>
<style>
  :root {
    --bg: #020617;
    --panel: #0f172a;
    --border: #334155;
    --text-main: #e2e8f0;
    --text-blue: #38bdf8;
    --text-green: #4ade80;
    --text-orange: #fb923c;
    --btn-edit: #eab308; /* Yellow */
    --btn-save: #22c55e; /* Green */
    
    /* 狀態按鈕顏色 */
    --status-open-bg: #ef4444; /* 紅色 */
    --status-open-text: #ffffff;
    --status-close-bg: #22c55e; /* 綠色 */
    --status-close-text: #ffffff;
  }

  body {
    margin: 0;
    padding: 20px;
    font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
    background: var(--bg);
    color: var(--text-main);
    display: flex;
    flex-direction: column;
    gap: 20px;
    height: 100vh;
    box-sizing: border-box;
  }

  /* === Top Area: Master Event Info === */
  .master-info {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    padding: 20px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }

  .info-group {
    display: flex;
    flex-direction: column;
  }
  
  .info-group label {
    color: var(--text-orange);
    font-size: 14px;
    margin-bottom: 5px;
  }
  
  .info-group div {
    color: var(--text-green);
    font-size: 18px;
    font-weight: bold;
    border-bottom: 1px solid var(--border);
    padding-bottom: 5px;
  }

  .full-width { grid-column: span 4; }

  /* === Action Bar === */
  .action-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 15px; /* 按鈕間距 */
  }
  
  .main-btn {
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    font-size: 16px;
    transition: transform 0.1s, box-shadow 0.2s;
  }
  .main-btn:active { transform: scale(0.96); }

  .btn-add { background: var(--text-blue); color: #000; }
  .btn-exit { background: #334155; color: #fff; border: 1px solid #475569; }

  /* === 狀態切換按鈕樣式 === */
  #btnStatus {
    min-width: 120px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }
  /* OPEN 狀態樣式 (紅色) */
  .status-open {
    background: var(--status-open-bg);
    color: var(--status-open-text);
    border: 1px solid #b91c1c;
  }
  /* CLOSE 狀態樣式 (綠色) */
  .status-close {
    background: var(--status-close-bg);
    color: var(--status-close-text);
    border: 1px solid #15803d;
  }

  /* === Log List Area === */
  .log-list-container {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding-right: 5px;
  }

  .log-row {
    display: grid;
    grid-template-columns: 200px 1fr 160px; 
    gap: 0;
    background: linear-gradient(180deg, #1e293b, #0f172a);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  /* Left Column */
  .log-left {
    padding: 15px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: rgba(15, 23, 42, 0.5);
  }

  .log-date {
    font-size: 16px;
    font-weight: bold;
    color: var(--text-blue);
    border: 1px solid var(--text-blue);
    padding: 4px;
    text-align: center;
    border-radius: 4px;
  }

  .log-engineer {
    text-align: center;
    color: var(--text-main);
    font-size: 14px;
    margin-top: auto;
  }

  /* Center Column */
  .log-center {
    padding: 10px;
    position: relative;
  }

  .log-textarea {
    width: 100%;
    height: 100%;
    min-height: 120px;
    background: transparent;
    border: 1px solid transparent;
    color: #fff;
    font-size: 16px;
    line-height: 1.5;
    resize: none;
    padding: 8px;
    box-sizing: border-box;
    font-family: inherit;
  }

  .log-textarea:not([readonly]) {
    border: 1px solid var(--text-orange);
    background: rgba(0, 0, 0, 0.3);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  }

  /* Right Column */
  .log-right {
    padding: 10px;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: rgba(15, 23, 42, 0.5);
  }

  .btn-row-action {
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    border: none;
    font-size: 14px;
    margin-bottom: 5px;
  }

  .btn-edit { background: var(--btn-edit); color: #000; }
  .btn-save { background: var(--btn-save); color: #fff; display: none; }

  .appendix-slot {
    flex: 1;
    border: 1px dashed #64748b;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #64748b;
    min-height: 25px;
  }

  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #020617; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #475569; }

</style>
</head>
<body>

  <div class="master-info">
    <div class="info-group full-width">
      <label>Event Title</label>
      <div id="mTitle">Loading...</div>
    </div>
    <div class="info-group">
      <label>Date</label>
      <div id="mDate">-</div>
    </div>
    <div class="info-group">
      <label>Customer</label>
      <div id="mCustomer">-</div>
    </div>
    <div class="info-group">
      <label>Machine</label>
      <div id="mMachine">-</div>
    </div>
    <div class="info-group">
      <label>Engineer</label>
      <div id="mEngineer">-</div>
    </div>
  </div>

  <div class="action-bar">
    <button id="btnStatus" class="main-btn status-open" onclick="toggleStatus()">Loading...</button>
    
    <button class="main-btn btn-add" onclick="openAddLog()">+ Add Record</button>
    <button class="main-btn btn-exit" onclick="window.close()">Exit</button>
  </div>

  <div class="log-list-container" id="logContainer">
    <div style="text-align:center; color:#64748b; padding:20px;">Loading History...</div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw3f4ch9YxN47QQ_Sa9vuTKk5-Y9yLJumm4wkozjWkxcMqiW9fAhLBxI2Lvd64DRrqn/exec';
let currentEventId = '';
let currentStatus = 'OPEN'; // 預設狀態

/* Init */
window.onload = function(){
  const params = new URLSearchParams(window.location.search);
  currentEventId = params.get('eventId');
  
  if(!currentEventId){
    alert('Missing Event ID');
    return;
  }
  
  loadData();
};

/* Load Data */
function loadData(){
  fetch(`${API_URL}?mode=eventFull&eventId=${currentEventId}`)
  .then(r => r.json())
  .then(res => {
    if(res.result !== 'OK'){
      alert(res.message);
      return;
    }
    renderMaster(res.event);
    renderLogs(res.logs);
  })
  .catch(err => console.error(err));
}

/* Render Master Info */
function renderMaster(data){
  document.getElementById('mTitle').textContent = data.EventTitle;
  document.getElementById('mDate').textContent = data.EventDate;
  document.getElementById('mCustomer').textContent = data.Customer;
  document.getElementById('mMachine').textContent = data.Machine;
  document.getElementById('mEngineer').textContent = data.Engineer;

  // 初始化狀態按鈕
  currentStatus = data.Status || 'OPEN';
  updateStatusButtonUI();
}

/* Render Logs List */
function renderLogs(logs){
  const container = document.getElementById('logContainer');
  container.innerHTML = ''; 

  if(!logs || logs.length === 0){
    container.innerHTML = '<div style="text-align:center; color:#64748b; padding:20px;">No history records found.</div>';
    return;
  }

  logs.forEach(log => {
    const displayDate = log.CreateTime.split(' ')[0]; 
    const row = document.createElement('div');
    row.className = 'log-row';
    row.innerHTML = `
      <div class="log-left">
        <div class="log-date">${displayDate}</div>
        <div class="log-engineer">${log.Engineer}</div>
      </div>
      <div class="log-center">
        <textarea id="desc_${log.LogID}" class="log-textarea" readonly>${log.ProcessDescribe}</textarea>
      </div>
      <div class="log-right">
        <button id="btnEdit_${log.LogID}" class="btn-row-action btn-edit" onclick="enableEdit('${log.LogID}')">Edit</button>
        <button id="btnSave_${log.LogID}" class="btn-row-action btn-save" onclick="saveLog('${log.LogID}')">Save</button>
        <div class="appendix-slot">Appx</div>
        <div class="appendix-slot">Appx</div>
      </div>
    `;
    container.appendChild(row);
  });
}

/* === 核心功能：狀態切換 (Toggle Status) === */
function toggleStatus(){
  const btn = document.getElementById('btnStatus');
  const oldStatus = currentStatus;
  const newStatus = (currentStatus === 'OPEN') ? 'CLOSE' : 'OPEN';

  // 1. 確認提示
  const confirmMsg = (newStatus === 'CLOSE') 
    ? 'Sure to CLOSE this event? It will disappear from Open List.' 
    : 'Sure to RE-OPEN this event?';
  
  if(!confirm(confirmMsg)) return;

  // 2. 鎖定按鈕避免連點
  btn.disabled = true;
  btn.textContent = 'Saving...';

  // 3. 呼叫後端 API
  const payload = {
    mode: 'updateStatus',
    EventID: currentEventId,
    Status: newStatus
  };

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if(res.result === 'OK'){
      // 4. 成功：更新本地狀態與 UI
      currentStatus = newStatus;
      updateStatusButtonUI();
      // 如果結案了，可以選擇是否提示
      if(newStatus === 'CLOSE'){
        // alert('Event Closed.'); 
      }
    } else {
      alert('Update Failed: ' + res.message);
      updateStatusButtonUI(); // 還原
    }
  })
  .catch(err => {
    alert('Connection Error');
    console.error(err);
    updateStatusButtonUI(); // 還原
  })
  .finally(() => {
    btn.disabled = false;
  });
}

// 根據 currentStatus 更新按鈕外觀
function updateStatusButtonUI(){
  const btn = document.getElementById('btnStatus');
  if(currentStatus === 'OPEN'){
    btn.textContent = 'OPEN';
    btn.className = 'main-btn status-open'; // 紅色
  } else {
    btn.textContent = 'CLOSE';
    btn.className = 'main-btn status-close'; // 綠色
  }
}

/* Enable Edit Mode (Log) */
function enableEdit(logId){
  const txt = document.getElementById(`desc_${logId}`);
  const btnEdit = document.getElementById(`btnEdit_${logId}`);
  const btnSave = document.getElementById(`btnSave_${logId}`);

  txt.removeAttribute('readonly');
  txt.focus();
  btnEdit.style.display = 'none';
  btnSave.style.display = 'block';
}

/* Save Log Changes */
function saveLog(logId){
  const txt = document.getElementById(`desc_${logId}`);
  const btnEdit = document.getElementById(`btnEdit_${logId}`);
  const btnSave = document.getElementById(`btnSave_${logId}`);
  
  const newContent = txt.value;
  btnSave.textContent = 'Saving...';
  txt.setAttribute('readonly', true);

  const payload = {
    mode: 'updateLog',
    LogID: logId,
    ProcessDescribe: newContent
  };

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if(res.result === 'OK'){
      btnSave.style.display = 'none';
      btnEdit.style.display = 'block';
      btnSave.textContent = 'Save';
    } else {
      alert('Save Failed: ' + res.message);
      txt.removeAttribute('readonly');
      btnSave.textContent = 'Save';
    }
  })
  .catch(err => {
    alert('Connection Error');
    txt.removeAttribute('readonly');
    btnSave.textContent = 'Save';
  });
}

function openAddLog(){
  window.open(`New Event Log.html?mode=add&eventId=${currentEventId}`, '_blank', 'width=1200,height=800');
}
</script>

</body>
</html>