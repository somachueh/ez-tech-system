<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Event Detail</title>
<style>
:root { 
  --bg:#020617; 
  --panel:#0f172a; 
  --text:#e5e7eb; 
  --orange:#fb923c; 
  --blue:#38bdf8; 
  --green:#4ade80;
  --yellow:#eab308;
  --line-color: #334155;
  --btn-log-save: #38bdf8;
}
body { margin:0; padding:20px; font-family:"Segoe UI"; background:var(--bg); color:var(--text); display:flex; flex-direction:column; gap:20px; height:100vh; box-sizing:border-box; }

/* === Master Info Area === */
.master-info {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;
  padding: 20px; background: var(--panel); border-radius: 12px; border:1px solid #334155;
}

.info-group { display: flex; flex-direction: column; }
.info-group label { color: var(--orange); font-size: 12px; margin-bottom: 5px; }

/* Editable Fields Style */
.editable-field {
  background: transparent;
  border: 1px solid transparent;
  border-bottom: 1px solid var(--line-color);
  color: var(--blue);
  font-weight: bold;
  font-size: 16px;
  padding: 5px;
  border-radius: 0;
  outline: none;
  font-family: inherit;
  width: 100%;
  box-sizing: border-box;
  transition: all 0.2s;
}

/* ç·¨è¼¯æ¨¡å¼ä¸‹çš„æ¨£å¼ */
.editable-field.editing {
  background: #1e293b;
  border: 1px solid #475569;
  border-bottom: 1px solid #38bdf8;
  color: #fff;
  border-radius: 4px;
  box-shadow: 0 0 5px rgba(56, 189, 248, 0.2);
}

/* === PRI å°ˆå±¬æ¨£å¼ (ç‡ˆè™Ÿä¸‹æ‹‰é¸å–®) === */
select.pri-selector {
  appearance: none; /* éš±è—é è¨­ç®­é ­ï¼Œè®“é¡è‰²æ»¿ç‰ˆ */
  text-align: center;
  font-weight: bold;
  cursor: pointer;
  border-radius: 6px;
  border: 1px solid transparent;
}
/* é–å®šæ™‚(éç·¨è¼¯æ¨¡å¼)ç¨å¾®é€æ˜ */
select.pri-selector[disabled] {
  opacity: 0.9;
  cursor: default;
  border-bottom: 1px solid var(--line-color); /* ç‚ºäº†è·Ÿå…¶ä»–æ¬„ä½ä¸€è‡´ */
}

/* ç‡ˆè™Ÿé¡è‰²å®šç¾© */
.pri-red { background-color: #ef4444 !important; color: white !important; }   /* Behind */
.pri-green { background-color: #22c55e !important; color: white !important; } /* Keep */
.pri-yellow { background-color: #eab308 !important; color: black !important; } /* Warning */
.pri-gray { background-color: #64748b !important; color: white !important; }   /* End */


/* Status Text Display */
.status-text {
  font-weight: bold;
  font-size: 16px;
  padding: 5px;
  border: 1px solid transparent; 
  border-bottom: 1px solid var(--line-color);
  color: var(--blue);
  cursor: not-allowed;
  opacity: 0.7;
}
.status-text.editing {
  cursor: pointer;
  opacity: 1;
  border: 1px solid #ef4444;
  background: rgba(239, 68, 68, 0.1);
  border-radius: 4px;
}

/* === Log Area === */
.log-container { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
.log-row { display:grid; grid-template-columns: 200px 1fr 100px; background:#1e293b; border-radius:8px; overflow:hidden; border:1px solid #334155; }
.log-left { padding:15px; background:#0f172a; display:flex; flex-direction:column; gap:5px; text-align:center; font-size:14px; }

.log-textarea {
  width: 100%; height: 100%; min-height: 80px;
  background: transparent; border: none; color: #e5e7eb;
  font-size: 16px; line-height: 1.5; resize: none; padding: 15px;
  box-sizing: border-box; font-family: inherit; outline: none;
}
.log-textarea.editing { background: #020617; border: 1px dashed #475569; }

.log-right { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; background: #0f172a; }
.btn-log-save { background: var(--btn-log-save); color: #000; border: none; padding: 5px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; display: none; }

/* === Action Buttons === */
.action-bar { display:flex; justify-content:flex-end; gap:10px; align-items:center; }
.btn { padding:10px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; font-size:14px; transition:0.2s; }
.btn:active { transform:scale(0.96); }

.btn-edit { background: var(--yellow); color: #000; }
.btn-save { background: var(--green); color: #000; display: none; } 
.btn-exit { background: #334155; color: #fff; border: 1px solid #475569; }

.status-btn { opacity: 0.5; cursor: not-allowed; }
.status-btn.active-mode { opacity: 1; cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.status-open { background:#ef4444; color:#fff; } 
.status-close { background:#22c55e; color:#fff; }
</style>
</head>
<body>

  <div class="master-info">
    
    <div class="info-group" style="grid-column:span 5">
      <label>Problem (Title)</label> 
      <input id="mProblem" class="editable-field" readonly>
    </div>

    <div class="info-group"><label>Date</label><input id="mDate" class="editable-field" readonly></div>
    <div class="info-group"><label>Project</label><input id="mProject" class="editable-field" readonly></div>
    <div class="info-group"><label>Customer</label><input id="mCustomer" class="editable-field" readonly></div>
    <div class="info-group"><label>Tool ID</label><input id="mToolID" class="editable-field" readonly></div>
    <div class="info-group"><label>Tool Type</label><input id="mToolType" class="editable-field" readonly></div>
    
    <div class="info-group"><label>CH</label><input id="mCH" class="editable-field" readonly></div>

    <div class="info-group">
      <label>PRI</label>
      <select id="mPRI" class="editable-field pri-selector" disabled onchange="updatePriColor()">
        <option value="Keep">Keep (Green)</option>
        <option value="Behind">Behind (Red)</option>
        <option value="Warning">Warning (Yellow)</option>
        <option value="End">End (Gray)</option>
      </select>
    </div>

    <div class="info-group"><label>ENG</label><input id="mENG" class="editable-field" readonly></div>
    
    <div class="info-group">
      <label>Status</label>
      <div id="mStatusDisplay" class="status-text">...</div>
    </div>
  </div>

  <div class="action-bar">
    <button id="btnEdit" class="btn btn-edit" onclick="enableEditMode()">Edit</button>
    <button id="btnSave" class="btn btn-save" onclick="saveMasterChanges()">Save (Master)</button>
    
    <button id="btnStatus" class="btn status-btn" onclick="toggleStatus()">Loading...</button>
    <button class="btn btn-exit" onclick="window.close()">Exit</button>
  </div>

  <div class="log-container" id="logBody"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw3f4ch9YxN47QQ_Sa9vuTKk5-Y9yLJumm4wkozjWkxcMqiW9fAhLBxI2Lvd64DRrqn/exec';
const p = new URLSearchParams(location.search);
const eid = p.get('eventId');

let currStatus = 'OPEN';
let isEditing = false;

/* === åˆå§‹åŒ– === */
fetch(`${API_URL}?mode=eventFull&eventId=${eid}`)
.then(r=>r.json())
.then(res=>{
  if(res.result!=='OK') return alert(res.message);
  
  const e = res.event;
  document.getElementById('mProblem').value = e.Problem;
  document.getElementById('mDate').value = e.Date;
  document.getElementById('mProject').value = e.Project;
  document.getElementById('mCustomer').value = e.Customer;
  document.getElementById('mToolID').value = e.CustomerToolID;
  document.getElementById('mToolType').value = e.ToolType;
  document.getElementById('mCH').value = e.Chamber;
  document.getElementById('mENG').value = e.ENG;
  
  // è¨­å®š PRI ä¸¦æ›´æ–°é¡è‰²
  const priSelect = document.getElementById('mPRI');
  priSelect.value = e.PRI || 'Keep'; // é è¨­ Keep
  updatePriColor(); // åˆå§‹åŒ–é¡è‰²

  document.getElementById('mStatusDisplay').innerText = e.Status;
  currStatus = e.Status;
  updateStatusBtnUI();

  // Render Logs
  const logDiv = document.getElementById('logBody');
  res.logs.forEach(l => {
    logDiv.innerHTML += `
      <div class="log-row">
        <div class="log-left">
          <div>${l.CreateTime.split(' ')[0]}</div>
          <div style="color:#38bdf8">${l.ENG}</div>
        </div>
        <div class="log-center">
          <textarea id="logtext_${l.LogID}" class="log-textarea" readonly>${l.Action}</textarea>
        </div>
        <div class="log-right">
          <button id="btnSaveLog_${l.LogID}" class="btn-log-save" onclick="saveSingleLog('${l.LogID}')">Save</button>
        </div>
      </div>`;
  });
});

/* === è¦–è¦ºï¼šPRI é¡è‰²è®Šæ›´é‚è¼¯ === */
function updatePriColor() {
  const sel = document.getElementById('mPRI');
  const val = sel.value;
  
  // ç§»é™¤èˆŠé¡è‰²
  sel.classList.remove('pri-red', 'pri-green', 'pri-yellow', 'pri-gray');
  
  // åŠ å…¥æ–°é¡è‰²
  if (val === 'Behind') sel.classList.add('pri-red');
  else if (val === 'Keep') sel.classList.add('pri-green');
  else if (val === 'Warning') sel.classList.add('pri-yellow');
  else if (val === 'End') sel.classList.add('pri-gray');
}

/* === æ ¸å¿ƒï¼šé–‹å•Ÿç·¨è¼¯æ¨¡å¼ === */
function enableEditMode(){
  isEditing = true;

  document.getElementById('btnEdit').style.display = 'none';
  document.getElementById('btnSave').style.display = 'block';

  // 1. è§£é–ä¸€èˆ¬æ–‡å­—æ¬„ä½
  const inputs = document.querySelectorAll('.editable-field:not(#mPRI)'); // æ’é™¤ PRIï¼Œå› ç‚ºè¦ç‰¹æ®Šè™•ç†
  inputs.forEach(input => {
    input.removeAttribute('readonly');
    input.classList.add('editing');
  });

  // 2. è™•ç† PRI æ¬„ä½ (æ ¹æ“š Status æ±ºå®šæ˜¯å¦è§£é–)
  const priSelect = document.getElementById('mPRI');
  priSelect.classList.add('editing'); // è¦–è¦ºä¸Šé€²å…¥ç·¨è¼¯æ¨¡å¼
  if (currStatus === 'OPEN') {
    priSelect.removeAttribute('disabled'); // åªæœ‰ OPEN æ‰èƒ½æ”¹
  } else {
    // é›–ç„¶é€²å…¥ç·¨è¼¯æ¨¡å¼ï¼Œä½†å¦‚æœæ˜¯ CLOSE ç‹€æ…‹ï¼ŒPRI å¿…é ˆç¶­æŒ End (Disabled)
    priSelect.setAttribute('disabled', true);
  }

  // 3. è§£é– Logs
  document.querySelectorAll('.log-textarea').forEach(area => {
    area.removeAttribute('readonly');
    area.classList.add('editing');
  });
  document.querySelectorAll('.btn-log-save').forEach(btn => {
    btn.style.display = 'block';
  });

  // 4. å•Ÿç”¨ Status æŒ‰éˆ•
  document.getElementById('btnStatus').classList.add('active-mode');
  document.getElementById('mStatusDisplay').classList.add('editing');
}

/* === å„²å­˜ä¸»æª” === */
function saveMasterChanges(){
  const btnSave = document.getElementById('btnSave');
  btnSave.innerText = 'Saving...';
  btnSave.disabled = true;

  // PRI å› ç‚ºå¯èƒ½è¢« disableï¼Œæ‰€ä»¥è¦ç¢ºå®šèƒ½å–åˆ°å€¼
  const priVal = document.getElementById('mPRI').value;

  const payload = {
    mode: 'updateEvent',
    EventID: eid,
    Problem: document.getElementById('mProblem').value,
    Date: document.getElementById('mDate').value,
    Project: document.getElementById('mProject').value,
    Customer: document.getElementById('mCustomer').value,
    CustomerToolID: document.getElementById('mToolID').value,
    ToolType: document.getElementById('mToolType').value,
    Chamber: document.getElementById('mCH').value,
    PRI: priVal, // å‚³é€ç‡ˆè™Ÿå€¼
    ENG: document.getElementById('mENG').value
  };

  fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
  .then(r => r.json())
  .then(res => {
    if(res.result === 'OK'){
      alert('âœ… Master Info Updated');
      location.reload(); 
    } else {
      alert('Failed: ' + res.message);
      btnSave.innerText = 'Save (Master)';
      btnSave.disabled = false;
    }
  });
}

/* === å„²å­˜ Log === */
function saveSingleLog(logId){
  const txt = document.getElementById(`logtext_${logId}`).value;
  const btn = document.getElementById(`btnSaveLog_${logId}`);
  btn.innerText = '...'; btn.disabled = true;

  fetch(API_URL, { method: 'POST', body: JSON.stringify({mode: 'updateLog', LogID: logId, Action: txt}) })
  .then(r => r.json()).then(res => {
    if(res.result === 'OK'){ alert('âœ… Log Updated'); btn.innerText = 'Save'; btn.disabled = false; }
    else { alert('Failed'); btn.innerText = 'Save'; btn.disabled = false; }
  });
}

/* === ç‹€æ…‹åˆ‡æ›é‚è¼¯ (é€£å‹• PRI) === */
function toggleStatus(){
  if(!isEditing){
    alert('ğŸ”’ Please click "Edit" first to change status.');
    return;
  }

  const next = currStatus==='OPEN'?'CLOSE':'OPEN';
  if(!confirm(`Change status to ${next}?`)) return;
  
  const btn = document.getElementById('btnStatus');
  btn.innerText = '...';
  
  fetch(API_URL, {method:'POST', body:JSON.stringify({mode:'updateStatus', EventID:eid, Status:next})})
  .then(r=>r.json()).then(res=>{
    if(res.result==='OK'){ 
      currStatus = next; 
      updateStatusBtnUI(); 
      document.getElementById('mStatusDisplay').innerText = next;

      // â˜…â˜…â˜… é€£å‹• PRI é‚è¼¯ â˜…â˜…â˜…
      const priSelect = document.getElementById('mPRI');
      if (next === 'CLOSE') {
        // è½‰ç‚º CLOSEï¼šPRI å¼·åˆ¶è®Š End (Gray)ï¼Œä¸¦é–å®š
        priSelect.value = 'End';
        priSelect.setAttribute('disabled', true);
      } else {
        // è½‰ç‚º OPENï¼šPRI è‡ªå‹•è®Šå› Keep (Green)ï¼Œä¸¦è§£é–
        priSelect.value = 'Keep';
        priSelect.removeAttribute('disabled');
      }
      updatePriColor(); // æ›´æ–°é¡è‰²é¡¯ç¤º
    }
  });
}

function updateStatusBtnUI(){
  const b = document.getElementById('btnStatus');
  b.innerText = currStatus;
  const baseClass = isEditing ? 'btn status-btn active-mode' : 'btn status-btn';
  b.className = `${baseClass} ${currStatus==='OPEN'?'status-open':'status-close'}`;
}
</script>
</body>
</html>